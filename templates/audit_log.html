{% extends "base.html" %}
{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Audit Log)</h2>
    <p class="text-muted">Ø³Ø¬Ù„ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‡Ø§Ù…Ø© Ø§Ù„ØªÙŠ ØªÙ…Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
    <hr>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" id="search-audit" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®..." onkeyup="searchAuditLog(this.value)">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-info" onclick="exportAuditLog()">
                <i class="bi bi-file-earmark-spreadsheet"></i> ØªØµØ¯ÙŠØ± Excel (CSV)
            </button>
        </div>
    </div>

    <div id="audit-log-table">
        <div class="alert alert-info">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadAuditLog);

    async function loadAuditLog() {
        const tableContainer = document.getElementById('audit-log-table');
        tableContainer.innerHTML = '<div class="alert alert-info">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';

        try {
            const response = await fetch('/api/audit-log');
            const data = await response.json();
            displayAuditLog(data);
        } catch (error) {
            tableContainer.innerHTML = '<div class="alert alert-danger">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.</div>';
            console.error('Error loading audit log:', error);
        }
    }

    function displayAuditLog(logs) {
        const tableContainer = document.getElementById('audit-log-table');
        if (logs.length === 0) {
            tableContainer.innerHTML = '<div class="alert alert-warning">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</div>';
            return;
        }

        let tableHTML = `
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody>
        `;

        logs.forEach(log => {
            tableHTML += `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString('ar-EG')}</td>
                    <td>${log.user_id}</td>
                    <td><span class="badge bg-secondary">${log.action}</span></td>
                    <td>${log.details}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = tableHTML;
    }

    async function searchAuditLog(query) {
        const tableContainer = document.getElementById('audit-log-table');
        if (query.length < 2) {
            loadAuditLog(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºÙ‹Ø§
            return;
        }
        
        tableContainer.innerHTML = '<div class="alert alert-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

        try {
            const response = await fetch(`/api/audit-log/search?q=${query}`);
            const data = await response.json();
            displayAuditLog(data);
        } catch (error) {
            tableContainer.innerHTML = '<div class="alert alert-danger">ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«.</div>';
            console.error('Error searching audit log:', error);
        }
    }

    async function exportAuditLog() {
        try {
            const response = await fetch('/api/export/audit-log');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
        } catch (error) {
            alert('âŒ ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±.');
            console.error('Error exporting audit log:', error);
        }
    }
</script>
{% endblock %}
